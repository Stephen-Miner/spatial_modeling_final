<!DOCTYPE html>
<html lang="en">
<head>
    <title>CPSC 487/587</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.19.1/dist/lil-gui.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.3.0/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quaternion@1.5.1/quaternion.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/numeric@1.2.6/numeric-1.2.6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stats.js@0.17.0/build/stats.min.js"></script>
    <script type="importmap">
        {
            "imports": {
              "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
              "three/": "https://unpkg.com/three@0.160.0/"
            }
        }
    </script>
</head>
<body>
<script type="module">
    import {ThreeEngine} from "./js/utils/utils_three.js";
    import {TransformGizmoEngine} from "./js/utils/utils_transform_gizmo.js";
    import {get_default_lil_gui} from "./js/utils/utils_three.js";
    import {add_matrix_matrix, mul_matrix_scalar} from "./js/utils/utils_math.js";
    import {refresh_displays} from "./js/utils/utils_three.js";
    import {set_object_pose_from_SE3_matrix} from "./js/utils/utils_transforms.js";
    import {mul_matrix_matrix} from "./js/utils/utils_math.js";


    let engine = ThreeEngine.new_default_3d();

    let global_settings = {
        ORBIT_LINE_SEGMENTS : 50,
        SIM_SPEED : 1,
    };

    class Planet {
        constructor(a, b, theta_1, theta_2, theta_3, speed){
            this.settings = {
                t : 0,
                a : a,
                b : b,
                theta_1 : theta_1,
                theta_2 : theta_2,
                theta_3 : theta_3,
                speed : speed
            };
            this.original_values = {
                t : this.settings.t,
                a : this.settings.a,
                b : this.settings.b,
                theta_1 : this.settings.theta_1,
                theta_2 : this.settings.theta_2,
                theta_3 : this.settings.theta_3,
                speed : this.settings.speed
            };
            this.so3 = [
                [Math.cos(this.settings.theta_2) * Math.cos(this.settings.theta_3), -Math.cos(this.settings.theta_2)*Math.sin(this.settings.theta_3), Math.sin(this.settings.theta_2)],
                [Math.cos(this.settings.theta_3) * Math.sin(this.settings.theta_1) * Math.sin(this.settings.theta_2) + Math.cos(this.settings.theta_1) * Math.sin(this.settings.theta_3), Math.cos(this.settings.theta_1) * Math.cos(this.settings.theta_3) - Math.sin(this.settings.theta_1) * Math.sin(this.settings.theta_2) * Math.sin(this.settings.theta_3), -Math.cos(this.settings.theta_2) * Math.sin(this.settings.theta_1)],
                [-Math.cos(this.settings.theta_1) * Math.cos(this.settings.theta_3) * Math.sin(this.settings.theta_2) + Math.sin(this.settings.theta_1) * Math.sin(this.settings.theta_3), Math.cos(this.settings.theta_3) * Math.sin(this.settings.theta_1) + Math.cos(this.settings.theta_1) * Math.sin(this.settings.theta_2) * Math.sin(this.settings.theta_3), Math.cos(this.settings.theta_1) * Math.cos(this.settings.theta_2)]
            ];

            this.tr = [
                [this.settings.a * Math.sin(this.settings.t)],
                [this.settings.b * Math.cos(this.settings.t)],
                [0]
            ];

        }
        update_planet() {
            this.so3 = [
                [Math.cos(this.settings.theta_2) * Math.cos(this.settings.theta_3), -Math.cos(this.settings.theta_2)*Math.sin(this.settings.theta_3), Math.sin(this.settings.theta_2)],
                [Math.cos(this.settings.theta_3) * Math.sin(this.settings.theta_1) * Math.sin(this.settings.theta_2) + Math.cos(this.settings.theta_1) * Math.sin(this.settings.theta_3), Math.cos(this.settings.theta_1) * Math.cos(this.settings.theta_3) - Math.sin(this.settings.theta_1) * Math.sin(this.settings.theta_2) * Math.sin(this.settings.theta_3), -Math.cos(this.settings.theta_2) * Math.sin(this.settings.theta_1)],
                [-Math.cos(this.settings.theta_1) * Math.cos(this.settings.theta_3) * Math.sin(this.settings.theta_2) + Math.sin(this.settings.theta_1) * Math.sin(this.settings.theta_3), Math.cos(this.settings.theta_3) * Math.sin(this.settings.theta_1) + Math.cos(this.settings.theta_1) * Math.sin(this.settings.theta_2) * Math.sin(this.settings.theta_3), Math.cos(this.settings.theta_1) * Math.cos(this.settings.theta_2)]
            ];

            this.tr = [
                [this.settings.a * Math.sin(this.settings.t)],
                [this.settings.b * Math.cos(this.settings.t)],
                [0]
            ];
        }
        reset_settings() {
            this.settings.t = this.original_values.t;
            this.settings.a = this.original_values.a
            this.settings.b = this.original_values.b
            this.settings.theta_1 = this.original_values.theta_1
            this.settings.theta_2 = this.original_values.theta_2
            this.settings.theta_3 = this.original_values.theta_3
            this.settings.speed = this.original_values.speed
        }
    }

    function draw_orbit (engine, num_line_segments, planet) {
        let increment = Math.PI / (num_line_segments)

        let planet_so3 = [
            [Math.cos(planet.settings.theta_2) * Math.cos(planet.settings.theta_3), -Math.cos(planet.settings.theta_2)*Math.sin(planet.settings.theta_3), Math.sin(planet.settings.theta_2)],
            [Math.cos(planet.settings.theta_3) * Math.sin(planet.settings.theta_1) * Math.sin(planet.settings.theta_2) + Math.cos(planet.settings.theta_1) * Math.sin(planet.settings.theta_3), Math.cos(planet.settings.theta_1) * Math.cos(planet.settings.theta_3) - Math.sin(planet.settings.theta_1) * Math.sin(planet.settings.theta_2) * Math.sin(planet.settings.theta_3), -Math.cos(planet.settings.theta_2) * Math.sin(planet.settings.theta_1)],
            [-Math.cos(planet.settings.theta_1) * Math.cos(planet.settings.theta_3) * Math.sin(planet.settings.theta_2) + Math.sin(planet.settings.theta_1) * Math.sin(planet.settings.theta_3), Math.cos(planet.settings.theta_3) * Math.sin(planet.settings.theta_1) + Math.cos(planet.settings.theta_1) * Math.sin(planet.settings.theta_2) * Math.sin(planet.settings.theta_3), Math.cos(planet.settings.theta_1) * Math.cos(planet.settings.theta_2)]
        ];

        for(let i = 0; i < num_line_segments; i++) {
            let planet_t_1 = [
                [planet.settings.a * Math.sin(increment * (i*2))],
                [planet.settings.b * Math.cos(increment * (i*2))],
                [0]
            ];
            let planet_t_2 = [
                [planet.settings.a * Math.sin(increment * (i+1)*2)],
                [planet.settings.b * Math.cos(increment * (i+1)*2)],
                [0]
            ];

            let point_1 = mul_matrix_matrix(planet_so3, planet_t_1);
            let point_2 = mul_matrix_matrix(planet_so3, planet_t_2);
            engine.draw_debug_line(point_1, point_2, true, 0.03, 0x00ff6e);
        }

    }

    let gui = get_default_lil_gui();

    let planets = [];
    let mercury = new Planet(15,10,0,-0.12,0,4.1);
    let venus = new Planet(25,19.5,0,-0.06,0, 1.62);
    let earth = new Planet(35,32.5,0,0,0,1);
    let mars = new Planet(45,37.5,0,-0.03,0,0.53);
    let jupiter = new Planet(70,65,0,-0.02,0,0.08);
    let saturn = new Planet(95,90,0,-0.059,0,0.03);
    let uranus = new Planet(120,117.5,0,-0.013,0,0.01);
    let neptune = new Planet(145,144,0,-0.03,0,0.006);
    let pluto = new Planet(170,120,0,0.30,0,0.004);
    planets.push(mercury);
    planets.push(venus);
    planets.push(earth);
    planets.push(mars);
    planets.push(jupiter);
    planets.push(saturn);
    planets.push(uranus);
    planets.push(neptune);
    planets.push(pluto);

    let actions = {
        reset_all : function() {
            for(let i = 0; i < planets.length; i++){
                planets[i].reset_settings();
            }
        }
    }

    gui.add(global_settings, "ORBIT_LINE_SEGMENTS");
    gui.add(global_settings, "SIM_SPEED");
    gui.add(actions, "reset_all").name("Reset All Orbits");

    let mercury_controls = gui.addFolder("Mercury Controls");
    mercury_controls.add(mercury.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    mercury_controls.add(mercury.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    mercury_controls.add(mercury.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    mercury_controls.add(mercury.settings, "speed");

    let venus_controls = gui.addFolder("Venus Controls");
    venus_controls.add(venus.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    venus_controls.add(venus.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    venus_controls.add(venus.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    venus_controls.add(venus.settings, "speed");

    let earth_controls = gui.addFolder("Earth Controls");
    earth_controls.add(earth.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    earth_controls.add(earth.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    earth_controls.add(earth.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    earth_controls.add(earth.settings, "speed");

    let mars_controls = gui.addFolder("Mars Controls");
    mars_controls.add(mars.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    mars_controls.add(mars.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    mars_controls.add(mars.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    mars_controls.add(mars.settings, "speed");

    let jupiter_controls = gui.addFolder("Jupiter Controls");
    jupiter_controls.add(jupiter.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    jupiter_controls.add(jupiter.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    jupiter_controls.add(jupiter.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    jupiter_controls.add(jupiter.settings, "speed");

    let saturn_controls = gui.addFolder("Saturn Controls");
    saturn_controls.add(saturn.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    saturn_controls.add(saturn.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    saturn_controls.add(saturn.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    saturn_controls.add(saturn.settings, "speed");

    let uranus_controls = gui.addFolder("Uranus Controls");
    uranus_controls.add(uranus.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    uranus_controls.add(uranus.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    uranus_controls.add(uranus.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    uranus_controls.add(uranus.settings, "speed");

    let neptune_controls = gui.addFolder("Neptune Controls");
    neptune_controls.add(neptune.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    neptune_controls.add(neptune.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    neptune_controls.add(neptune.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    neptune_controls.add(neptune.settings, "speed");

    let pluto_controls = gui.addFolder("Pluto Controls");
    pluto_controls.add(pluto.settings, "theta_1", -2 * Math.PI, 2 * Math.PI);
    pluto_controls.add(pluto.settings, "theta_2", -2 * Math.PI, 2 * Math.PI);
    pluto_controls.add(pluto.settings, "theta_3", -2 * Math.PI, 2 * Math.PI);
    pluto_controls.add(pluto.settings, "speed");

    engine.animation_loop( ()  => {
        engine.draw_debug_sphere([0,0,0], 7.0, 0xf6ff47);
        let delta_t = engine.get_delta_time_from_last_frame()

        mercury.settings.t = mercury.settings.t + delta_t * (global_settings.SIM_SPEED * mercury.settings.speed * Math.PI);
        mercury.update_planet();
        let mercury_point = mul_matrix_matrix(mercury.so3, mercury.tr);
        engine.draw_debug_sphere(mercury_point, 0.14, 0x707070);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, mercury)

        venus.settings.t = venus.settings.t + delta_t * (global_settings.SIM_SPEED * venus.settings.speed * Math.PI);
        venus.update_planet();
        let venus_point = mul_matrix_matrix(venus.so3, venus.tr);
        engine.draw_debug_sphere(venus_point, 0.36, 0xf5f0f0);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, venus)

        earth.settings.t = earth.settings.t + delta_t * (global_settings.SIM_SPEED* earth.settings.speed * Math.PI);
        earth.update_planet();
        let earth_point = mul_matrix_matrix(earth.so3, earth.tr);
        engine.draw_debug_sphere(earth_point, 0.4, 0x0000ff);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, earth)

        mars.settings.t = mars.settings.t + delta_t * (global_settings.SIM_SPEED * mars.settings.speed * Math.PI);
        mars.update_planet();
        let mars_point = mul_matrix_matrix(mars.so3, mars.tr);
        engine.draw_debug_sphere(mars_point, 0.2, 0xf57231);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, mars)

        jupiter.settings.t = jupiter.settings.t + delta_t * (global_settings.SIM_SPEED * jupiter.settings.speed * Math.PI);
        jupiter.update_planet();
        let jupiter_point = mul_matrix_matrix(jupiter.so3, jupiter.tr);
        engine.draw_debug_sphere(jupiter_point, 4.4, 0xf5ae8c);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, jupiter)

        saturn.settings.t = saturn.settings.t + delta_t * (global_settings.SIM_SPEED * saturn.settings.speed * Math.PI);
        saturn.update_planet();
        let saturn_point = mul_matrix_matrix(saturn.so3, saturn.tr);
        engine.draw_debug_sphere(saturn_point, 3.9, 0xeba146);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, saturn)

        uranus.settings.t = uranus.settings.t + delta_t * (global_settings.SIM_SPEED * uranus.settings.speed * Math.PI);
        uranus.update_planet();
        let uranus_point = mul_matrix_matrix(uranus.so3, uranus.tr);
        engine.draw_debug_sphere(uranus_point, 1.6, 0xcad6fc);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, uranus)

        neptune.settings.t = neptune.settings.t + delta_t * (global_settings.SIM_SPEED * neptune.settings.speed * Math.PI);
        neptune.update_planet();
        let neptune_point = mul_matrix_matrix(neptune.so3, neptune.tr);
        engine.draw_debug_sphere(neptune_point, 1.6, 0x113fd1);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, neptune)

        pluto.settings.t = pluto.settings.t + delta_t * (global_settings.SIM_SPEED * pluto.settings.speed * Math.PI);
        pluto.update_planet();
        let pluto_point = mul_matrix_matrix(pluto.so3, pluto.tr);
        engine.draw_debug_sphere(pluto_point, 0.08, 0xfafafa);
        draw_orbit(engine, global_settings.ORBIT_LINE_SEGMENTS, pluto)

        refresh_displays(gui);
    });

</script>
</body>
</html>